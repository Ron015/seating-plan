{% extends "base.html" %}

{% block title %}Edit Room - PM SHRI JNV GB NAGAR{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-building-gear"></i> Edit Exam Room</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('rooms') }}">Rooms</a></li>
                        <li class="breadcrumb-item active">Edit Room</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-building"></i> Update Room Configuration</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_room') }}" method="post" id="editRoomForm">
                        <input type="hidden" name="original_room_id" id="original_room_id">
                        
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <label for="room_id" class="form-label">Room ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="room_id" name="room_id" required>
                                <div class="form-text">Unique identifier for the examination room</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="rows" class="form-label">Number of Rows <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="rows" name="rows" min="1" max="20" required oninput="calculateCapacity()">
                                <div class="form-text">Rows of desks in the room</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="columns" class="form-label">Number of Columns <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="columns" name="columns" min="1" max="20" required oninput="calculateCapacity()">
                                <div class="form-text">Columns of desks in the room</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="extra_desks" class="form-label">Extra Desks</label>
                                <input type="number" class="form-control" id="extra_desks" name="extra_desks" min="0" max="50" value="0" oninput="calculateCapacity()">
                                <div class="form-text">Additional single desks</div>
                            </div>
                        </div>

                        <!-- Capacity Display -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="bi bi-calculator"></i> Capacity Calculation</h6>
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <h5 id="baseDesks" class="text-primary">0</h5>
                                                <small class="text-muted">Base Desks</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h5 id="baseCapacity" class="text-success">0</h5>
                                                <small class="text-muted">Base Capacity</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h5 id="extraCapacity" class="text-info">+0</h5>
                                                <small class="text-muted">Extra Seats</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h5 id="totalCapacity" class="text-warning">0</h5>
                                                <small class="text-muted">Total Capacity</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle"></i> Important Notice</h6>
                            <ul class="mb-0 small">
                                <li>Changing room capacity may affect existing seating arrangements</li>
                                <li>Reducing capacity might leave some students unassigned</li>
                                <li>Room ID changes will update all related seating plans</li>
                                <li>Consider regenerating seating plans after major changes</li>
                            </ul>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('rooms') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Rooms
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-danger me-2" onclick="confirmDelete()">
                                    <i class="bi bi-trash"></i> Delete Room
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg"></i> Update Room
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Current Room Details</h6>
                </div>
                <div class="card-body" id="roomDetails">
                    <div class="text-muted small">Loading room information...</div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-diagram-3"></i> Layout Visualization</h6>
                </div>
                <div class="card-body">
                    <div id="roomLayout" class="text-center">
                        <div class="text-muted small">Room layout preview will appear here</div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-people"></i> Assignment Status</h6>
                </div>
                <div class="card-body" id="assignmentStatus">
                    <div class="text-muted small">Loading assignment information...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this room?</p>
                <div class="alert alert-danger">
                    <strong>This action cannot be undone!</strong><br>
                    The room will be removed from all seating arrangements and configurations.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteRoom()">
                    <i class="bi bi-trash"></i> Delete Room
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentRoom = null;

function calculateCapacity() {
    const rows = parseInt(document.getElementById('rows').value) || 0;
    const columns = parseInt(document.getElementById('columns').value) || 0;
    const extraDesks = parseInt(document.getElementById('extra_desks').value) || 0;
    
    const baseDesks = rows * columns;
    const baseCapacity = baseDesks * 2;
    const extraCapacity = extraDesks * 2;
    const totalCapacity = baseCapacity + extraCapacity;
    
    document.getElementById('baseDesks').textContent = baseDesks;
    document.getElementById('baseCapacity').textContent = baseCapacity;
    document.getElementById('extraCapacity').textContent = '+' + extraCapacity;
    document.getElementById('totalCapacity').textContent = totalCapacity;
    
    updateLayoutVisualization(rows, columns, extraDesks);
}

function updateLayoutVisualization(rows, columns, extraDesks) {
    const layoutContainer = document.getElementById('roomLayout');
    let layoutHtml = '<div class="room-layout">';
    
    // Create grid visualization
    for (let r = 0; r < Math.min(rows, 8); r++) {
        layoutHtml += '<div class="row-layout mb-1">';
        for (let c = 0; c < Math.min(columns, 10); c++) {
            layoutHtml += '<span class="badge bg-primary me-1">□</span>';
        }
        layoutHtml += '</div>';
    }
    
    if (extraDesks > 0) {
        layoutHtml += '<div class="extra-desks mt-2">';
        layoutHtml += '<small class="text-muted">Extra Desks: </small>';
        for (let i = 0; i < Math.min(extraDesks, 10); i++) {
            layoutHtml += '<span class="badge bg-info me-1">○</span>';
        }
        if (extraDesks > 10) {
            layoutHtml += '<span class="text-muted">... +' + (extraDesks - 10) + '</span>';
        }
        layoutHtml += '</div>';
    }
    
    layoutHtml += '</div>';
    layoutContainer.innerHTML = layoutHtml;
}

// Load room data from URL parameter
function loadRoomData() {
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room_id');
    
    if (!roomId) {
        alert('No room specified');
        window.location.href = '{{ url_for("rooms") }}';
        return;
    }
    
    fetch('{{ url_for("get_rooms_data") }}')
        .then(response => response.json())
        .then(rooms => {
            currentRoom = rooms.find(r => r.room_id === roomId);
            
            if (!currentRoom) {
                alert('Room not found');
                window.location.href = '{{ url_for("rooms") }}';
                return;
            }
            
            populateForm(currentRoom);
            displayRoomDetails(currentRoom);
            calculateCapacity();
        })
        .catch(error => {
            console.error('Error loading room data:', error);
            alert('Error loading room data');
        });
}

function populateForm(room) {
    document.getElementById('original_room_id').value = room.room_id;
    document.getElementById('room_id').value = room.room_id;
    document.getElementById('rows').value = room.rows;
    document.getElementById('columns').value = room.columns;
    document.getElementById('extra_desks').value = room.extra_desks || 0;
}

function displayRoomDetails(room) {
    const detailsContainer = document.getElementById('roomDetails');
    detailsContainer.innerHTML = `
        <div class="mb-3">
            <strong>Current Configuration:</strong>
        </div>
        <div class="row">
            <div class="col-12 mb-2">
                <strong>Room ID:</strong><br>
                <code>${room.room_id}</code>
            </div>
            <div class="col-12 mb-2">
                <strong>Grid Layout:</strong><br>
                ${room.rows} rows × ${room.columns} columns
            </div>
            <div class="col-12 mb-2">
                <strong>Extra Desks:</strong><br>
                <span class="badge bg-info">${room.extra_desks || 0}</span>
            </div>
            <div class="col-12 mb-2">
                <strong>Total Capacity:</strong><br>
                <span class="badge bg-success">${room.capacity}</span> students
            </div>
        </div>
    `;
}

function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

function deleteRoom() {
    const roomId = document.getElementById('original_room_id').value;
    
    // Create a form to submit delete request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("delete_room") }}';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'room_id';
    input.value = roomId;
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadRoomData();
});
</script>
{% endblock %}