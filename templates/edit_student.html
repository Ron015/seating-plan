{% extends "base.html" %}

{% block title %}Edit Student - PM SHRI JNV GB NAGAR{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-person-gear"></i> Edit Student</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('students') }}">Students</a></li>
                        <li class="breadcrumb-item active">Edit Student</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Update Student Information</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_student') }}" method="post" id="editStudentForm">
                        <input type="hidden" name="original_roll_number" id="original_roll_number">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="roll_number" class="form-label">Roll Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="roll_number" name="roll_number" required>
                                <div class="form-text">Unique roll number for the student</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required>
                                <div class="form-text">Student's full name as per records</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="class_name" class="form-label">Class <span class="text-danger">*</span></label>
                                <select class="form-select" id="class_name" name="class_name" required>
                                    <option value="">Select Class</option>
                                    <option value="6">Class 6</option>
                                    <option value="7">Class 7</option>
                                    <option value="8">Class 8</option>
                                    <option value="9">Class 9</option>
                                    <option value="10">Class 10</option>
                                    <option value="11">Class 11</option>
                                    <option value="12">Class 12</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="section" class="form-label">Section <span class="text-danger">*</span></label>
                                <select class="form-select" id="section" name="section" required>
                                    <option value="">Select Section</option>
                                    <option value="A">Section A</option>
                                    <option value="B">Section B</option>
                                    <option value="C">Section C</option>
                                    <option value="D">Section D</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle"></i> Important Notice</h6>
                            <ul class="mb-0 small">
                                <li>Changing roll number will update all related seating arrangements</li>
                                <li>Class/section changes may affect existing seating plans</li>
                                <li>Make sure the new roll number doesn't conflict with existing students</li>
                            </ul>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('students') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Students
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-danger me-2" onclick="confirmDelete()">
                                    <i class="bi bi-trash"></i> Delete Student
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg"></i> Update Student
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Edit History</h6>
                </div>
                <div class="card-body">
                    <div class="text-muted small">Student modification history will appear here</div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Student Details</h6>
                </div>
                <div class="card-body" id="studentDetails">
                    <div class="text-muted small">Loading student information...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this student?</p>
                <div class="alert alert-danger">
                    <strong>This action cannot be undone!</strong><br>
                    The student will be removed from all seating arrangements.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteStudent()">
                    <i class="bi bi-trash"></i> Delete Student
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentStudent = null;

// Load student data from URL parameter
function loadStudentData() {
    const urlParams = new URLSearchParams(window.location.search);
    const rollNumber = urlParams.get('roll_number');
    
    if (!rollNumber) {
        alert('No student specified');
        window.location.href = '{{ url_for("students") }}';
        return;
    }
    
    fetch('{{ url_for("get_student_data") }}')
        .then(response => response.json())
        .then(students => {
            currentStudent = students.find(s => 
                (s.roll_number === rollNumber) || 
                (s['Roll Number'] === rollNumber)
            );
            
            if (!currentStudent) {
                alert('Student not found');
                window.location.href = '{{ url_for("students") }}';
                return;
            }
            
            populateForm(currentStudent);
            displayStudentDetails(currentStudent);
        })
        .catch(error => {
            console.error('Error loading student data:', error);
            alert('Error loading student data');
        });
}

function populateForm(student) {
    document.getElementById('original_roll_number').value = student.roll_number || student['Roll Number'] || '';
    document.getElementById('roll_number').value = student.roll_number || student['Roll Number'] || '';
    document.getElementById('name').value = student.name || student['Name'] || '';
    
    // Handle class field (could be 'class' or 'Class')
    const classValue = student.class || student['Class'] || '';
    const classNumber = classValue.toString().replace(/[^0-9]/g, '');
    document.getElementById('class_name').value = classNumber;
    
    // Handle section
    const section = student.section || student['Section'] || classValue.replace(/[^A-Z]/g, '');
    document.getElementById('section').value = section;
    
    // Handle gender
    const gender = (student.gender || student['Gender'] || '').toLowerCase();
    document.getElementById('gender').value = gender;
}

function displayStudentDetails(student) {
    const detailsContainer = document.getElementById('studentDetails');
    detailsContainer.innerHTML = `
        <div class="mb-3">
            <strong>Current Information:</strong>
        </div>
        <div class="row">
            <div class="col-12 mb-2">
                <strong>Roll Number:</strong><br>
                <code>${student.roll_number || student['Roll Number'] || 'N/A'}</code>
            </div>
            <div class="col-12 mb-2">
                <strong>Name:</strong><br>
                ${student.name || student['Name'] || 'N/A'}
            </div>
            <div class="col-12 mb-2">
                <strong>Class:</strong><br>
                <span class="badge bg-primary">${student.class || student['Class'] || 'N/A'}</span>
            </div>
            <div class="col-12 mb-2">
                <strong>Gender:</strong><br>
                <span class="badge bg-info">${student.gender || student['Gender'] || 'N/A'}</span>
            </div>
        </div>
    `;
}

function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

function deleteStudent() {
    const rollNumber = document.getElementById('original_roll_number').value;
    
    // Create a form to submit delete request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("delete_student") }}';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'roll_number';
    input.value = rollNumber;
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadStudentData();
});
</script>
{% endblock %}